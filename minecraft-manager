#!/usr/bin/make -f

# --- Variables ---
# ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ IP ‡∏à‡∏≤‡∏Å Terraform ‡πÅ‡∏ö‡∏ö Dynamic
GET_LB_IP    = $(shell terraform output -raw load_balancer_ip 2>/dev/null)
CLUSTER_NAME := $(shell gcloud container clusters list --format="value(name)" --limit=1)
LOC          := $(shell gcloud container clusters list --format="value(location)" --limit=1)
DEPLOY_NAME  := $(shell kubectl get deployments -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | grep "minecraft" | head -n 1)

.PHONY: help setup deploy stop start status logs

help:
	@echo "üõ†Ô∏è Minecraft Manager Tool"
	@echo "Usage: mc [command]"
	@echo "Commands: setup, deploy, start, stop, status, logs"

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á mc ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà
setup:
	@echo "üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á 'mc'..."
	@chmod +x $(CURDIR)/minecraft-manager
	@mkdir -p $(HOME)/.local/bin
	@ln -sf $(CURDIR)/minecraft-manager $(HOME)/.local/bin/mc
	@echo "‚úÖ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á 'mc' ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢"

# üöÄ ‡∏î‡∏∂‡∏á IP ‡∏à‡∏≤‡∏Å Terraform ‡πÅ‡∏•‡∏∞‡∏â‡∏µ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ YAML ‡∏Å‡πà‡∏≠‡∏ô Deploy
deploy:
	@echo "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á Load Balancer IP ‡∏à‡∏≤‡∏Å Terraform..."
	@if [ -z "$(GET_LB_IP)" ]; then \
		echo "‚ùå Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡πà‡∏≤ load_balancer_ip ‡πÉ‡∏ô Terraform output!"; \
		exit 1; \
	fi
	@echo "üöÄ ‡∏û‡∏ö IP: $(GET_LB_IP) | ‡∏Å‡∏≥‡∏•‡∏±‡∏á Deploy ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Kubernetes..."
	@# ‡πÉ‡∏ä‡πâ envsubst ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô $LB_IP ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå YAML ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç IP ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
	@export LB_IP=$(GET_LB_IP) && envsubst < minecraft-k8s.yaml | kubectl apply -f -
	@echo "‚úÖ Deployment ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"

stop:
	@echo "üõë ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå..."
	@kubectl scale deployment $(DEPLOY_NAME) --replicas=0
	@echo "‚úÖ ‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏£‡∏∞‡∏ö‡∏ö Autopilot ‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤ Compute ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)"

start:
	@echo "üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå..."
	@kubectl scale deployment $(DEPLOY_NAME) --replicas=1
	@echo "‚è≥ ‡∏£‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Pod..."
	@kubectl get pods -w

status:
	@echo "üåê Current IP: $(GET_LB_IP)"
	@echo "üìç Cluster: $(CLUSTER_NAME) ($(LOC))"
	@echo "--------------------------------------------------"
	@kubectl get pods,svc

logs:
	@kubectl logs -f deployment/$(DEPLOY_NAME)

flush:
	kubectl exec deployment/$(DEPLOY_NAME) -- rcon-cli save-all flush